import{b as pe}from"./chunk-YGTZ3GJV.js";import{a as he}from"./chunk-U5PGGOO3.js";import{A as me,a as ce,w as de}from"./chunk-2E2WOBKK.js";import{A as Q,B as Z,D as ee,F as te,G as ie,Q as ne,R as re,U as ae,W as oe,aa as se,c as N,f as V,g as j,ga as le,h as z,i as K,j as $,l as Y,p as G,u as H,v as X,x as J}from"./chunk-B7BKEKPT.js";import"./chunk-EKYO6VDW.js";import"./chunk-24IHF5HR.js";import"./chunk-KFDLIPX5.js";import"./chunk-EPJFQAWK.js";import"./chunk-4UA7XWWY.js";import"./chunk-3P4LCZSC.js";import"./chunk-QB2INVK3.js";import"./chunk-T4NRX6V6.js";import"./chunk-R2OJ64UA.js";import"./chunk-RPLHLNGJ.js";import"./chunk-JZD5S6T4.js";import"./chunk-G223UPOJ.js";import"./chunk-ZSV5V4UX.js";import"./chunk-6AR4DOND.js";import"./chunk-67J5UTTO.js";import"./chunk-3QTGG56W.js";import"./chunk-SACCBILY.js";import"./chunk-GYT6Z5WN.js";import{Hb as q,I as o,J as C,Ja as R,Jb as B,Ka as A,M as P,Q as _,Sa as F,T as m,Tb as L,Y as e,Z as t,_ as v,_a as U,ab as W,ca as k,da as x,ea as p,pa as i,qa as f,ra as b,sa as T,ta as O,u as I,v as S,va as M,wa as D,xa as E}from"./chunk-YS7BCJTD.js";import"./chunk-5BIRNKZZ.js";import"./chunk-PN5KWPLT.js";import"./chunk-ZPEM7JC5.js";import"./chunk-AQXWH6LN.js";import"./chunk-XFZJ45JG.js";import"./chunk-QYFRFJTZ.js";import"./chunk-MN6QQCMN.js";import"./chunk-TP642E63.js";import"./chunk-SRRF7I6H.js";import{h}from"./chunk-LNJ3S2LQ.js";function ue(r,c){if(r&1&&(e(0,"p")(1,"strong"),i(2),t(),v(3,"br"),i(4),v(5,"br"),i(6),t()),r&2){let n=p();o(2),f(n.selectedAddress.name),o(2),T(" ",n.selectedAddress.street,", ",n.selectedAddress.city,","),o(2),T(" ",n.selectedAddress.state," - ",n.selectedAddress.zip," ")}}function ge(r,c){if(r&1&&(e(0,"ion-item")(1,"ion-label")(2,"h2"),i(3),t(),e(4,"p"),i(5),t()(),e(6,"ion-note",8),i(7),t()()),r&2){let n=c.$implicit;o(3),f(n.product_name),o(2),O("\u20B9",n.latest_wholesaler_price," x ",n.quantity," ",n.unit_name,""),o(2),b(" \u20B9",n.latest_wholesaler_price*n.quantity," ")}}function fe(r,c){if(r&1){let n=k();e(0,"ion-label")(1,"p")(2,"a",13),x("click",function(){I(n);let l=p();return S(l.arrangeRide())}),i(3,"Do you want us to arrange a ride for you?"),t()()()}}function _e(r,c){r&1&&(e(0,"div",18),v(1,"ion-spinner",19),e(2,"p"),i(3,"Searching for available drivers..."),t()())}function ye(r,c){if(r&1&&(e(0,"div",20)(1,"ion-item",3)(2,"ion-label")(3,"h3"),i(4,"Assigned Driver"),t(),e(5,"p"),i(6),t()()()()),r&2){let n=p(2);o(6),f(n.getAvailableTransporterName())}}function ve(r,c){if(r&1){let n=k();e(0,"div",21)(1,"ion-button",22),x("click",function(){I(n);let l=p(2);return S(l.confirmDriverSearch())}),i(2," Search for Driver "),t(),e(3,"ion-button",23),x("click",function(){I(n);let l=p(2);return S(l.arrangeRide())}),i(4," Change Transport Options "),t()()}}function xe(r,c){if(r&1&&(e(0,"div")(1,"div",14)(2,"ion-item",3)(3,"ion-label")(4,"h3"),i(5,"Delivery Type"),t(),e(6,"p"),i(7),t()()(),e(8,"ion-item",3)(9,"ion-label")(10,"h3"),i(11,"Urgency"),t(),e(12,"p"),i(13),t()()(),e(14,"ion-item",3)(15,"ion-label")(16,"h3"),i(17,"Estimated Cost"),t(),e(18,"p"),i(19),t()()()(),_(20,_e,4,0,"div",15)(21,ye,7,1,"div",16)(22,ve,5,0,"div",17),t()),r&2){let n=p();o(7),f(n.selectedDeliveryType),o(6),f(n.selectedUrgency),o(6),b("\u20B9",n.estimatedRidePrice,""),o(),m("ngIf",n.isSearchingDriver),o(),m("ngIf",n.selectedTransporter),o(),m("ngIf",!n.isSearchingDriver&&!n.selectedTransporter)}}function Ce(r,c){if(r&1&&(e(0,"ion-item",3)(1,"ion-label"),i(2,"Transport Cost"),t(),e(3,"ion-note",8),i(4),t()()),r&2){let n=p();o(4),b("\u20B9",n.estimatedRidePrice,"")}}function be(r,c){if(r&1&&(e(0,"ion-item",26)(1,"ion-label"),i(2),t(),v(3,"ion-radio",27),t()),r&2){let n=c.$implicit;o(2),f(n.payment_mode),o(),m("value",n.payment_mode)}}function Ie(r,c){if(r&1){let n=k();e(0,"ion-card")(1,"ion-card-header")(2,"ion-card-title"),i(3,"Select Payment Method"),t()(),e(4,"ion-card-content")(5,"ion-radio-group",24),E("ngModelChange",function(l){I(n);let s=p();return D(s.selectedPaymentMethod,l)||(s.selectedPaymentMethod=l),S(l)}),e(6,"ion-list"),_(7,be,4,2,"ion-item",25),t()()()()}if(r&2){let n=p();o(5),M("ngModel",n.selectedPaymentMethod),o(2),m("ngForOf",n.paymentMethods)}}function Se(r,c){r&1&&(e(0,"ion-card")(1,"ion-card-content")(2,"div",28),v(3,"ion-spinner",29),e(4,"p"),i(5,"Loading payment methods..."),t()()()())}function we(r,c){r&1&&(e(0,"ion-card")(1,"ion-card-content")(2,"ion-text",30),i(3," \u26A0\uFE0F Failed to load payment methods. Please try again later. "),t()()())}var qe=(()=>{let c=class c{constructor(a,l,s,d,y){var g;this.router=a,this.route=l,this.databaseService=s,this.alertCtrl=d,this.buyerApiService=y,this.cartItems=[],this.retailerInfo=null,this.wholeSeller=null,this.totalPrice=0,this.selectedPaymentMethod="upi",this.estimatedDelivery="3-5 Business Days",this.trackingNumber="TRK123456789",this.orderPlaced=!1,this.isLoading=!1,this.selectedDeliveryType=null,this.selectedUrgency=null,this.estimatedRidePrice=0,this.grandTotal=0,this.selectedTransporter=null,this.availableTransporters=[],this.isSearchingDriver=!1,this.hasRideRequest=!1,this.selectedAddress={name:"ABC",street:"123 XY",city:"New Delhi",state:"Delhi",zip:"110001"},this.loadingPaymentMethods=!1,this.errorLoadingPaymentMethods=!1,this.paymentMethods=[],this.currentOrderId=null,ce({chevronBack:de,chevronForward:me}),this.loadTransporters();let u=(g=this.router.getCurrentNavigation())==null?void 0:g.extras.state;u&&(this.cartItems=u.cartItems||[],this.totalPrice=u.totalPrice||0,this.retailerInfo=u.retailer||null,this.wholeSeller=u.wholeseller||null),this.route.queryParams.subscribe(w=>{w.deliveryType&&(this.selectedDeliveryType=w.deliveryType,this.hasRideRequest=!0),w.urgency&&(this.selectedUrgency=w.urgency),this.hasRideRequest&&setTimeout(()=>this.confirmDriverSearch(),100),this.calculateRidePrice()})}ngOnInit(){this.paymentMethods=[{id:1,payment_mode:"UPI"},{id:2,payment_mode:"Cash on Delivery"},{id:3,payment_mode:"Credit/Debit Card"},{id:4,payment_mode:"Net Banking"},{id:5,payment_mode:"Wallet (e.g., Paytm, PhonePe)"}]}loadTransporters(){this.availableTransporters=this.databaseService.getAvailableTransporters()}calculateRidePrice(){if(this.selectedDeliveryType&&this.selectedAddress){let a=this.calculateTotalWeight();this.estimatedRidePrice=this.databaseService.calculateBasePrice(this.selectedAddress.city,"Destination",a,this.selectedDeliveryType,this.selectedUrgency||"normal",this.selectedTransporter||void 0)}else this.estimatedRidePrice=0;this.grandTotal=this.totalPrice+this.estimatedRidePrice}selectTransporter(a){this.selectedTransporter=a,this.calculateRidePrice()}arrangeRide(){this.router.navigate(["/buyer/ride"],{queryParams:{totalWeight:this.calculateTotalWeight(),pickup:this.selectedAddress.city,delivery:"Destination"}})}confirmDriverSearch(){return h(this,null,function*(){yield(yield this.alertCtrl.create({header:"Estimated Transport Cost",message:`The estimated transport cost is \u20B9${this.estimatedRidePrice}. Would you like to search for an available driver?`,buttons:[{text:"No",role:"cancel",handler:()=>{this.hasRideRequest=!1,this.selectedDeliveryType=null,this.selectedUrgency=null,this.estimatedRidePrice=0,this.calculateRidePrice()}},{text:"Yes",handler:()=>{this.startDriverSearch()}}]})).present()})}calculateTotalWeight(){return console.log(this.cartItems),this.cartItems.reduce((a,l)=>a+(l.quantity||0),0)}startDriverSearch(){return h(this,null,function*(){this.isSearchingDriver=!0,this.pollForDriverAssignment()})}pollForDriverAssignment(){return h(this,null,function*(){if(this.currentOrderId){console.warn("Already polling for order:",this.currentOrderId);return}let a={deliveryType:this.selectedDeliveryType,urgency:this.selectedUrgency,pickup:this.selectedAddress.city,delivery:"Destination",distance:this.getDistance(),load:{weight:this.calculateTotalWeight(),type:""},basePrice:this.estimatedRidePrice,requestedDate:new Date().toISOString()},l=yield this.databaseService.createUnassignedOrder(a);this.currentOrderId=l;let s=setInterval(()=>h(this,null,function*(){console.log("Checking driver assignment for order:",this.currentOrderId);let d=yield this.databaseService.checkOrderAssignment(this.currentOrderId);console.log("Driver assignment result:",d),d&&(this.isSearchingDriver=!1,this.selectedTransporter=d.id,clearInterval(s),this.currentOrderId=null,this.showDriverFoundAlert(d))}),5e3);setTimeout(()=>{this.isSearchingDriver&&(clearInterval(s),this.isSearchingDriver=!1,this.currentOrderId=null,this.showNoDriverAlert())},12e4)})}getDistance(){return Math.floor(Math.random()*101)+50}showDriverFoundAlert(a){return h(this,null,function*(){yield(yield this.alertCtrl.create({header:"Driver Found!",message:`${a.name} will handle your delivery.`,buttons:["OK"]})).present()})}showNoDriverAlert(){return h(this,null,function*(){yield(yield this.alertCtrl.create({header:"No Driver Available",message:"Would you like to continue searching?",buttons:[{text:"No",role:"cancel",handler:()=>{this.hasRideRequest=!1,this.selectedDeliveryType=null,this.selectedUrgency=null,this.estimatedRidePrice=0,this.calculateRidePrice()}},{text:"Yes",handler:()=>{this.startDriverSearch()}}]})).present()})}confirmOrder(){return h(this,null,function*(){if(!this.selectedTransporter){yield(yield this.alertCtrl.create({header:"No Transporter Selected",message:"Your order will be processed directly with the seller without transport arrangement.",buttons:[{text:"Cancel",role:"cancel"},{text:"Continue",handler:()=>{this.processDirectOrder()}}]})).present();return}yield this.processOrderWithTransport()})}processDirectOrder(){return h(this,null,function*(){var a,l,s,d;this.isLoading=!0;try{let y={id:Date.now(),buyerId:((a=this.retailerInfo)==null?void 0:a.id.toString())||"unknown",sellerId:((l=this.wholeSeller)==null?void 0:l.id.toString())||"unknown",items:this.cartItems.map(g=>({product_id:g.product_id,quantity:g.quantity,price:g.latest_wholesaler_price,unit_id:g.unit_id})),totalAmount:this.totalPrice,pickupLocation:((s=this.wholeSeller)==null?void 0:s.name)||"Unknown Location",dropoffLocation:((d=this.retailerInfo)==null?void 0:d.address)||"Unknown Address",weight:this.calculateTotalWeight(),status:"pending",createdAt:new Date,transportRequired:!1},u=yield this.databaseService.assignDirectOrder(y);u.success?(this.orderPlaced=!0,yield(yield this.alertCtrl.create({header:"Success",message:"Order sent directly to seller!",buttons:["OK"]})).present()):yield(yield this.alertCtrl.create({header:"Error",message:u.message||"Failed to place direct order.",buttons:["OK"]})).present()}catch(y){console.error("Error processing direct order:",y),yield(yield this.alertCtrl.create({header:"Error",message:"An unexpected error occurred.",buttons:["OK"]})).present()}finally{this.isLoading=!1}})}processOrderWithTransport(){return h(this,null,function*(){var a,l;this.isLoading=!0;try{let s={items:this.cartItems,paymentMethod:this.selectedPaymentMethod,total:this.grandTotal,deliveryType:this.selectedDeliveryType,urgency:this.selectedUrgency,transporterId:this.selectedTransporter,pickupLocation:((a=this.wholeSeller)==null?void 0:a.name)||"Unknown Location",dropoffLocation:((l=this.retailerInfo)==null?void 0:l.address)||"Unknown Address",weight:this.calculateTotalWeight()},d=yield this.databaseService.assignOrderToTransporters(s);d.success?(this.orderPlaced=!0,yield(yield this.alertCtrl.create({header:"Success",message:"Order confirmed successfully!",buttons:["OK"]})).present()):yield(yield this.alertCtrl.create({header:"Error",message:d.message||"Failed to assign order.",buttons:["OK"]})).present()}finally{this.isLoading=!1}})}goBack(){this.router.navigate(["/buyer/cart"])}changeAddress(){this.router.navigate(["/buyer/select-address"])}selectPayment(a){this.selectedPaymentMethod=a}getAvailableTransporterName(){if(!this.selectedTransporter)return"";let a=this.availableTransporters.find(l=>l.id===this.selectedTransporter);return(a==null?void 0:a.name)||""}getRetailerInfo(){return this.retailerInfo?`${this.retailerInfo.name||"Unknown"} - ${this.retailerInfo.location||"Unknown Location"}`:"Unknown Retailer"}getWholesellerInfo(){return this.wholeSeller?`${this.wholeSeller.name||"Unknown Wholeseller"}`:"Direct Order"}};c.\u0275fac=function(l){return new(l||c)(C(W),C(U),C(pe),C(se),C(he))},c.\u0275cmp=P({type:c,selectors:[["app-checkout"]],decls:71,vars:13,consts:[["slot","start"],[3,"click"],["name","chevron-back"],["lines","none"],[4,"ngIf"],[1,"change-address-btn",3,"click"],[4,"ngFor","ngForOf"],[1,"ride-selection"],["slot","end","color","medium"],["lines","none",4,"ngIf"],["lines","none",1,"grand-total"],["slot","end","color","dark"],["expand","block",1,"confirm-order-btn",3,"click","disabled"],[1,"ride-link",3,"click"],[1,"delivery-info"],["class","search-status",4,"ngIf"],["class","driver-info",4,"ngIf"],["class","action-buttons",4,"ngIf"],[1,"search-status"],["name","circles"],[1,"driver-info"],[1,"action-buttons"],["expand","block",3,"click"],["expand","block","fill","outline",3,"click"],[3,"ngModelChange","ngModel"],["lines","none","class","radio-item",4,"ngFor","ngForOf"],["lines","none",1,"radio-item"],["slot","end",3,"value"],[1,"loading-container"],["name","dots"],["color","danger"]],template:function(l,s){l&1&&(e(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",0)(3,"ion-button",1),x("click",function(){return s.goBack()}),v(4,"ion-icon",2),t()(),e(5,"ion-title"),i(6,"Checkout"),t()()(),e(7,"ion-content")(8,"ion-card")(9,"ion-card-header")(10,"ion-card-title"),i(11,"Order Details"),t()(),e(12,"ion-card-content")(13,"ion-item",3)(14,"ion-label")(15,"h2"),i(16,"Buyer"),t(),e(17,"p"),i(18),t()()(),e(19,"ion-item",3)(20,"ion-label")(21,"h2"),i(22,"Seller"),t(),e(23,"p"),i(24),t()()()()(),e(25,"ion-card")(26,"ion-card-header")(27,"ion-card-title"),i(28,"Delivery Address"),t()(),e(29,"ion-card-content"),_(30,ue,7,5,"p",4),e(31,"ion-button",5),x("click",function(){return s.changeAddress()}),i(32,"Change Address"),t()()(),e(33,"ion-card")(34,"ion-card-header")(35,"ion-card-title"),i(36,"Order Items"),t()(),e(37,"ion-card-content")(38,"ion-list"),_(39,ge,8,5,"ion-item",6),t()()(),e(40,"ion-card",7)(41,"ion-card-header")(42,"ion-card-title"),i(43,"Transport Options"),t()(),e(44,"ion-card-content"),_(45,fe,4,0,"ion-label",4)(46,xe,23,6,"div",4),t()(),e(47,"ion-card")(48,"ion-card-header")(49,"ion-card-title"),i(50,"Order Summary"),t()(),e(51,"ion-card-content")(52,"ion-list")(53,"ion-item",3)(54,"ion-label"),i(55,"Items Total"),t(),e(56,"ion-note",8),i(57),t()(),_(58,Ce,5,1,"ion-item",9),e(59,"ion-item",10)(60,"ion-label")(61,"strong"),i(62,"Grand Total"),t()(),e(63,"ion-note",11)(64,"strong"),i(65),t()()()()()(),_(66,Ie,8,2,"ion-card",4)(67,Se,6,0,"ion-card",4)(68,we,4,0,"ion-card",4),e(69,"ion-button",12),x("click",function(){return s.confirmOrder()}),i(70," Confirm Order "),t()()),l&2&&(o(18),f(s.getRetailerInfo()),o(6),f(s.getWholesellerInfo()),o(6),m("ngIf",s.selectedAddress),o(9),m("ngForOf",s.cartItems),o(6),m("ngIf",!s.hasRideRequest),o(),m("ngIf",s.hasRideRequest),o(11),b("\u20B9",s.totalPrice,""),o(),m("ngIf",s.hasRideRequest),o(7),b("\u20B9",s.grandTotal,""),o(),m("ngIf",!s.loadingPaymentMethods&&s.paymentMethods.length),o(),m("ngIf",s.loadingPaymentMethods),o(),m("ngIf",s.errorLoadingPaymentMethods),o(),m("disabled",s.orderPlaced||!s.selectedPaymentMethod))},dependencies:[F,R,A,le,V,j,z,K,$,Y,G,H,X,J,Q,Z,ee,te,ie,ne,re,ae,oe,N,L,q,B],styles:["ion-card-title[_ngcontent-%COMP%]{font-size:18px}ion-card-content[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:13px;color:#333;margin-bottom:10px}.change-address-btn[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;margin:10px auto;width:80%}ion-button.change-address-btn[_ngcontent-%COMP%]{--border-radius: 8px;--background: rgb(136, 172, 140);--color: white;--padding: 10px;font-size:14px;font-weight:700;text-transform:uppercase}ion-header[_ngcontent-%COMP%]   ion-toolbar[_ngcontent-%COMP%]{--background: radial-gradient(circle, #ffffff 0%, #eef2f3 100%);--color: rgb(174, 172, 172)}ion-header[_ngcontent-%COMP%]   ion-toolbar[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{color:#88ac8c}.ride-selection[_ngcontent-%COMP%]{background:linear-gradient(135deg,#88ac8c,#fef548);border-radius:12px;display:flex;justify-content:center;margin:20px;box-shadow:0 4px 8px #0003}.ride-selection[_ngcontent-%COMP%]   ion-card-content[_ngcontent-%COMP%]{padding:16px}.ride-selection[_ngcontent-%COMP%]   .ride-link[_ngcontent-%COMP%]{color:#4f4e4e;font-weight:700}ion-item.selected-option[_ngcontent-%COMP%]{--background: rgb(178, 222, 183);border-radius:8px;transition:background-color .3s ease}ion-item[_ngcontent-%COMP%]{cursor:pointer;--padding-start: 16px;--inner-padding-end: 12px;font-size:16px;font-weight:500}ion-icon[_ngcontent-%COMP%]{font-size:18px;color:#646464}.search-status[_ngcontent-%COMP%]{text-align:center;padding:20px 0}.search-status[_ngcontent-%COMP%]   ion-spinner[_ngcontent-%COMP%]{display:block;margin:0 auto 10px}.search-status[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:var(--ion-color-medium)}.action-buttons[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:10px;margin-top:16px}.delivery-info[_ngcontent-%COMP%]{margin-bottom:20px;padding:10px;background:var(--ion-color-light);border-radius:8px}.driver-info[_ngcontent-%COMP%]{margin-top:20px;padding:10px;background:var(--ion-color-success-light);border-radius:8px}.radio-item[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center}ion-radio[_ngcontent-%COMP%]::part(container){border:2px solid rgb(136,172,140);border-radius:50%;width:18px;height:18px;background:#fff}ion-radio[aria-checked=true][_ngcontent-%COMP%]::part(container){background:#88ac8c;border:2px solid rgb(136,172,140)}ion-radio[aria-checked=true][_ngcontent-%COMP%]::part(mark){display:none}.confirm-order-btn[_ngcontent-%COMP%]{--background: rgb(136, 172, 140);width:60%;margin:16px auto;display:block;text-align:center}"]});let r=c;return r})();export{qe as CheckoutComponent};
